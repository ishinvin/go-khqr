package khqr

import (
	"errors"
	"testing"
)

func TestDecode(t *testing.T) {
	t.Parallel()

	tests := []struct {
		name string
		qr   string
		want DecodedData
	}{
		// --- Basic cases ---
		{
			"individual",
			"00020101021229190015john_smith@devb52045999530311654065000.05802KH5910jonh smith6010Phnom Penh62360109#INV-20030313Coffee Klaing0702#299170013161302797275763049ACF",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				TransactionCurrency:     "116",
				MerchantName:            "jonh smith",
				TransactionAmount:       "5000.0",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				BillNumber:              "#INV-2003",
				StoreLabel:              "Coffee Klaing",
				TerminalLabel:           "#2",
				CreationTimestamp:       "1613027972757",
				CRC:                     "9ACF",
			},
		},
		{
			"merchant",
			"00020101021230410015john_smith@devb01061234560208Dev Bank52045999530384054035.05802KH5916john smith actor6010Phnom Penh62130709Counter 299170013161343857579463048EF2",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantID:              "123456",
				AcquiringBank:           "Dev Bank",
				MerchantType:            Merchant,
				TransactionCurrency:     "840",
				MerchantName:            "john smith actor",
				TransactionAmount:       "5.0",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				TerminalLabel:           "Counter 2",
				CreationTimestamp:       "1613438575794",
				CRC:                     "8EF2",
			},
		},
		{
			"merchant_with_bill_and_terminal",
			"00020101021230410015john_smith@devb01061234560208Dev Bank52045999530384054035.05802KH5916john smith actor6010Phnom Penh62280111Invoice#0690709Counter 29917001316134385758926304384E",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantID:              "123456",
				AcquiringBank:           "Dev Bank",
				MerchantType:            Merchant,
				TransactionCurrency:     "840",
				MerchantName:            "john smith actor",
				TransactionAmount:       "5.0",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				BillNumber:              "Invoice#069",
				TerminalLabel:           "Counter 2",
				CreationTimestamp:       "1613438575892",
				CRC:                     "384E",
			},
		},
		{
			"merchant_with_bill_only",
			"00020101021230410015john_smith@devb01061234560208Dev Bank52045999530384054035.05802KH5916john smith actor6010Phnom Penh62150111Invoice#0699917001316134385758926304552D",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantID:              "123456",
				AcquiringBank:           "Dev Bank",
				MerchantType:            Merchant,
				TransactionCurrency:     "840",
				MerchantName:            "john smith actor",
				TransactionAmount:       "5.0",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				BillNumber:              "Invoice#069",
				CreationTimestamp:       "1613438575892",
				CRC:                     "552D",
			},
		},

		// --- Non-standard EMV / bank-specific ---
		{
			"non_standard_emv",
			"000201010211021641277800000000980416518352888000006030470016abaakhppxxx@abaa01153166007701102420204abaa5204224253038405802KH5910USD OUTLET6010PHNOM PENH62250509115B02750070827CE19809924001339CA026411FDA6803mmp63043870",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "11",
				BakongAccountID:         "abaakhppxxx@abaa",
				MerchantID:              "316600770110242",
				AcquiringBank:           "abaa",
				MerchantType:            Merchant,
				TransactionCurrency:     "840",
				MerchantName:            "USD OUTLET",
				MerchantCategoryCode:    "2242",
				CountryCode:             "KH",
				MerchantCity:            "PHNOM PENH",
				TerminalLabel:           "27CE1980",
				CreationTimestamp:       "39CA026411FDA",
				CRC:                     "3870",
			},
		},
		{
			"acleda_with_language",
			"00020101021130470009khqr@aclb0111855124649170215ACLEDA Bank Plc5204599953038405802KH5907BUN MAO6010Phnom Penh6102126213020901050033164310002KM0107BUN MAO0210Phnom Penh6304E313",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "11",
				BakongAccountID:         "khqr@aclb",
				MerchantID:              "85512464917",
				AcquiringBank:           "ACLEDA Bank Plc",
				MerchantType:            Merchant,
				TransactionCurrency:     "840",
				MerchantName:            "BUN MAO",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				MobileNumber:            "010500331",
				CRC:                     "E313",
				AltLanguagePreference:   "KM",
				AltMerchantName:         "BUN MAO",
				AltMerchantCity:         "Phnom Penh",
			},
		},
		{
			"acleda_with_language_v2",
			"00020101021130640009khqr@aclb0111855124649060215ACLEDA Bank Plc051385500000019425204593153038405802KH5912KHQR TESTING6010Phnom Penh6102126213020901753577164360002KM0112KHQR TESTING0210Phnom Penh6304AC1C",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "11",
				BakongAccountID:         "khqr@aclb",
				MerchantID:              "85512464906",
				AcquiringBank:           "ACLEDA Bank Plc",
				MerchantType:            Merchant,
				TransactionCurrency:     "840",
				MerchantName:            "KHQR TESTING",
				MerchantCategoryCode:    "5931",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				MobileNumber:            "017535771",
				CRC:                     "AC1C",
				AltLanguagePreference:   "KM",
				AltMerchantName:         "KHQR TESTING",
				AltMerchantCity:         "Phnom Penh",
			},
		},
		{
			"individual_all_fields",
			"00020101021229310014jonhsmith@nbcq0109012345678520459995303116540750000.05802KH5910Jonh Smith6009Siam Reap62550117INV-2021-07-658220211855123456780305BKK-1070601234599170013163039583850263041134",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "jonhsmith@nbcq",
				AccountInfo:             "012345678",
				MerchantType:            Individual,
				TransactionCurrency:     "116",
				MerchantName:            "Jonh Smith",
				TransactionAmount:       "50000.0",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "Siam Reap",
				BillNumber:              "INV-2021-07-65822",
				StoreLabel:              "BKK-1",
				TerminalLabel:           "012345",
				MobileNumber:            "85512345678",
				CreationTimestamp:       "1630395838502",
				CRC:                     "1134",
			},
		},

		// --- Minimal / edge cases ---
		{
			"crc_only",
			"63041234",
			DecodedData{
				CRC: "1234",
			},
		},
		{
			"merchant_tags_reordered",
			"00020101021230410015john_smith@devb01061234560208Dev Bank53038405204599954035.05802KH5916john smith actor6010Phnom Penh62150111Invoice#06999170013161343857589263040437",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantID:              "123456",
				AcquiringBank:           "Dev Bank",
				MerchantType:            Merchant,
				TransactionCurrency:     "840",
				MerchantName:            "john smith actor",
				TransactionAmount:       "5.0",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				BillNumber:              "Invoice#069",
				CreationTimestamp:       "1613438575892",
				CRC:                     "0437",
			},
		},
		{
			"no_merchant_account",
			"00020101021252045999530384054035.05802KH5916john smith actor6010Phnom Penh62150111Invoice#06999170013161343857589263042494",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				TransactionCurrency:     "840",
				MerchantName:            "john smith actor",
				TransactionAmount:       "5.0",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				BillNumber:              "Invoice#069",
				CreationTimestamp:       "1613438575892",
				CRC:                     "2494",
			},
		},
		{
			"merchant_account_id_only",
			"000201010212301900151234567890123456304D807",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "123456789012345",
				MerchantType:            Merchant,
				CRC:                     "D807",
			},
		},
		{
			"long_account_id",
			"00020101021230440040123456789012345678901234567890123456789063041747",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "1234567890123456789012345678901234567890",
				MerchantType:            Merchant,
				CRC:                     "1747",
			},
		},

		{
			"pfi_too_long",
			"000301001021230190015john_smith@devb630493FD",
			DecodedData{
				PayloadFormatIndicator:  "010",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Merchant,
				CRC:                     "93FD",
			},
		},

		// --- Missing / invalid field tests ---
		{
			"missing_pfi",
			"01021230190015john_smith@devb52045999530384054035.05802KH5916john smith actor6010Phnom Penh62150111Invoice#06999170013161343857589263044598",
			DecodedData{
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Merchant,
				TransactionCurrency:     "840",
				MerchantName:            "john smith actor",
				TransactionAmount:       "5.0",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				BillNumber:              "Invoice#069",
				CreationTimestamp:       "1613438575892",
				CRC:                     "4598",
			},
		},
		{
			"poi_too_long",
			"000201010312330190015john_smith@devb63040FC8",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "123",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Merchant,
				CRC:                     "0FC8",
			},
		},
		{
			"mcc_three_digits",
			"00020101021229190015john_smith@devb5203999630454EF",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				MerchantCategoryCode:    "999",
				CRC:                     "54EF",
			},
		},
		{
			"individual_no_mcc",
			"00020101021229190015john_smith@devb530384054035.05802KH5916john smith actor6010Phnom Penh62150111Invoice#0699917001316134385758926304F926",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				TransactionCurrency:     "840",
				MerchantName:            "john smith actor",
				TransactionAmount:       "5.0",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				BillNumber:              "Invoice#069",
				CreationTimestamp:       "1613438575892",
				CRC:                     "F926",
			},
		},
		{
			"currency_too_long",
			"00020101021229190015john_smith@devb52045999530488406304FEA6",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				MerchantCategoryCode:    "5999",
				TransactionCurrency:     "8840",
				CRC:                     "FEA6",
			},
		},
		{
			"individual_no_currency",
			"00020101021229190015john_smith@devb5204599954035.05802KH5916john smith actor6010Phnom Penh62150111Invoice#0699917001316134385758926304E7DF",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				MerchantCategoryCode:    "5999",
				TransactionAmount:       "5.0",
				CountryCode:             "KH",
				MerchantName:            "john smith actor",
				MerchantCity:            "Phnom Penh",
				BillNumber:              "Invoice#069",
				CreationTimestamp:       "1613438575892",
				CRC:                     "E7DF",
			},
		},
		{
			"country_code_too_long",
			"00020101021229190015john_smith@devb52045999530384054035.05803KKH63042FD2",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				MerchantCategoryCode:    "5999",
				TransactionCurrency:     "840",
				TransactionAmount:       "5.0",
				CountryCode:             "KKH",
				CRC:                     "2FD2",
			},
		},
		{
			"no_country_code",
			"00020101021229190015john_smith@devb52045999530384054035.05916john smith actor6010Phnom Penh62150111Invoice#06999170013161343857589263040023",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				MerchantCategoryCode:    "5999",
				TransactionCurrency:     "840",
				TransactionAmount:       "5.0",
				MerchantName:            "john smith actor",
				MerchantCity:            "Phnom Penh",
				BillNumber:              "Invoice#069",
				CreationTimestamp:       "1613438575892",
				CRC:                     "0023",
			},
		},
		{
			"city_too_long",
			"00020101021229190015john_smith@devb52045999530384054035.05802KH5916john smith actor60170123456789012345663040EF3",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				MerchantCategoryCode:    "5999",
				TransactionCurrency:     "840",
				TransactionAmount:       "5.0",
				CountryCode:             "KH",
				MerchantName:            "john smith actor",
				MerchantCity:            "01234567890123456",
				CRC:                     "0EF3",
			},
		},
		{
			"empty_city",
			"00020101021229190015john_smith@devb52045999530384054035.05802KH5916john smith actor600062150111Invoice#0699917001316134385758926304389D",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				MerchantCategoryCode:    "5999",
				TransactionCurrency:     "840",
				TransactionAmount:       "5.0",
				CountryCode:             "KH",
				MerchantName:            "john smith actor",
				BillNumber:              "Invoice#069",
				CreationTimestamp:       "1613438575892",
				CRC:                     "389D",
			},
		},
		{
			"no_city",
			"00020101021229190015john_smith@devb52045999530384054035.05802KH5916john smith actor62150111Invoice#06999170013161343857589263043B26",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				MerchantCategoryCode:    "5999",
				TransactionCurrency:     "840",
				TransactionAmount:       "5.0",
				CountryCode:             "KH",
				MerchantName:            "john smith actor",
				BillNumber:              "Invoice#069",
				CreationTimestamp:       "1613438575892",
				CRC:                     "3B26",
			},
		},
		{
			"long_merchant_name",
			"00020101021229190015john_smith@devb52045999530384054035.05802KH59307PL7EvxHpgpP4jT4uMgegaYqgv3Ehb6010Phnom Penh6304399D",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				MerchantCategoryCode:    "5999",
				TransactionCurrency:     "840",
				TransactionAmount:       "5.0",
				CountryCode:             "KH",
				MerchantName:            "7PL7EvxHpgpP4jT4uMgegaYqgv3Ehb",
				MerchantCity:            "Phnom Penh",
				CRC:                     "399D",
			},
		},
		{
			"empty_merchant_name",
			"00020101021229190015john_smith@devb52045999530384054035.05802KH59006010Phnom Penh630414A7",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				MerchantCategoryCode:    "5999",
				TransactionCurrency:     "840",
				TransactionAmount:       "5.0",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				CRC:                     "14A7",
			},
		},
		{
			"no_merchant_name",
			"00020101021229190015john_smith@devb52045999530384054035.05802KH6010Phnom Penh62150111Invoice#06999170013161343857589263043518",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				MerchantCategoryCode:    "5999",
				TransactionCurrency:     "840",
				TransactionAmount:       "5.0",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				BillNumber:              "Invoice#069",
				CreationTimestamp:       "1613438575892",
				CRC:                     "3518",
			},
		},

		// --- Empty optional fields ---
		{
			"empty_bill_number",
			"00020101021229190015john_smith@devb52045999530311654065000.05802KH5910jonh smith6010Phnom Penh622701000313Coffee Klaing0702#29917001316130279727576304D219",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				TransactionCurrency:     "116",
				MerchantName:            "jonh smith",
				TransactionAmount:       "5000.0",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				StoreLabel:              "Coffee Klaing",
				TerminalLabel:           "#2",
				CreationTimestamp:       "1613027972757",
				CRC:                     "D219",
			},
		},
		{
			"empty_store_label",
			"00020101021229190015john_smith@devb52045999530311654065000.05802KH5910jonh smith6010Phnom Penh62230109#INV-200303000702#299170013161302797275763049BD2",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				TransactionCurrency:     "116",
				MerchantName:            "jonh smith",
				TransactionAmount:       "5000.0",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				BillNumber:              "#INV-2003",
				TerminalLabel:           "#2",
				CreationTimestamp:       "1613027972757",
				CRC:                     "9BD2",
			},
		},
		{
			"empty_terminal_label",
			"00020101021229190015john_smith@devb52045999530311654065000.05802KH5910jonh smith6010Phnom Penh62340109#INV-20030313Coffee Klaing07009917001316130279727576304F593",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				TransactionCurrency:     "116",
				MerchantName:            "jonh smith",
				TransactionAmount:       "5000.0",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				BillNumber:              "#INV-2003",
				StoreLabel:              "Coffee Klaing",
				CreationTimestamp:       "1613027972757",
				CRC:                     "F593",
			},
		},
		{
			"unsupported_currency",
			"00020101021229190015john_smith@devb52045999530384954035.05802KH5916john smith actor6010Phnom Penh9917001316134385758926304951E",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				MerchantCategoryCode:    "5999",
				TransactionCurrency:     "849",
				TransactionAmount:       "5.0",
				CountryCode:             "KH",
				MerchantName:            "john smith actor",
				MerchantCity:            "Phnom Penh",
				CreationTimestamp:       "1613438575892",
				CRC:                     "951E",
			},
		},

		// --- Tags not in order ---
		{
			"tags_not_in_order",
			"00020101021130580016cznbkhppxxx@cznb01061007310224KB Kookmin Bank Cambodia5204599953031165802KH6010PHNOM PENH5912Le Pure Cafe62400107#1007310312Le Pure Cafe0709KHM10073199170013163047617398663048FDD",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "11",
				BakongAccountID:         "cznbkhppxxx@cznb",
				MerchantID:              "100731",
				AcquiringBank:           "KB Kookmin Bank Cambodia",
				MerchantType:            Merchant,
				TransactionCurrency:     "116",
				MerchantName:            "Le Pure Cafe",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "PHNOM PENH",
				BillNumber:              "#100731",
				StoreLabel:              "Le Pure Cafe",
				TerminalLabel:           "KHM100731",
				CreationTimestamp:       "1630476173986",
				CRC:                     "8FDD",
			},
		},
		{
			"acleda_khr_with_language",
			"00020101021130640009khqr@aclb0111855124649060215ACLEDA Bank Plc051385500000019435204593153031165802KH5912KHQR TESTING6010Phnom Penh6102126213020901753577164360002KM0112KHQR TESTING0210Phnom Penh63045451",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "11",
				BakongAccountID:         "khqr@aclb",
				MerchantID:              "85512464906",
				AcquiringBank:           "ACLEDA Bank Plc",
				MerchantType:            Merchant,
				TransactionCurrency:     "116",
				MerchantName:            "KHQR TESTING",
				MerchantCategoryCode:    "5931",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				MobileNumber:            "017535771",
				CRC:                     "5451",
				AltLanguagePreference:   "KM",
				AltMerchantName:         "KHQR TESTING",
				AltMerchantCity:         "Phnom Penh",
			},
		},

		// --- Purpose and UPI ---
		{
			"individual_with_purpose",
			"00020101021129180014jonhsmith@nbcq5204599953031165802KH5910Jonh Smith6010Phnom Penh62260211855123456780807Testing99170013168733590258463047929",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "11",
				BakongAccountID:         "jonhsmith@nbcq",
				MerchantType:            Individual,
				TransactionCurrency:     "116",
				MerchantName:            "Jonh Smith",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				MobileNumber:            "85512345678",
				Purpose:                 "Testing",
				CreationTimestamp:       "1687335902584",
				CRC:                     "7929",
			},
		},
		{
			"individual_with_upi",
			"00020101021115231234567812345678901234529180014jonhsmith@nbcq5204599953031165802KH5910Jonh Smith6010Phnom Penh9917001316873161811616304E2DC",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "11",
				UPIAccountInfo:          "12345678123456789012345",
				BakongAccountID:         "jonhsmith@nbcq",
				MerchantType:            Individual,
				TransactionCurrency:     "116",
				MerchantName:            "Jonh Smith",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				CreationTimestamp:       "1687316181161",
				CRC:                     "E2DC",
			},
		},

		// --- Full fields with Khmer ---
		{
			"individual_khmer_full_fields",
			"00020101021229460015john_smith@devb0111855122334550208Dev Bank52045999530384054031005802KH5910John Smith6010PHNOM PENH62670106#123450211855122334550311Coffee Shop0709Cashier_10810Buy coffee64280002km0108ចន ស្មីន0206ភ្នំពញ993400131726821915797011317268220357976304B73E",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				AccountInfo:             "85512233455",
				AcquiringBank:           "Dev Bank",
				MerchantType:            Individual,
				TransactionCurrency:     "840",
				MerchantName:            "John Smith",
				TransactionAmount:       "100",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "PHNOM PENH",
				BillNumber:              "#12345",
				MobileNumber:            "85512233455",
				StoreLabel:              "Coffee Shop",
				TerminalLabel:           "Cashier_1",
				Purpose:                 "Buy coffee",
				AltLanguagePreference:   "km",
				AltMerchantName:         "ចន ស្មីន",
				AltMerchantCity:         "ភ្នំពញ",
				CreationTimestamp:       "1726821915797",
				ExpirationTimestamp:     "1726822035797",
				CRC:                     "B73E",
			},
		},
		{
			"merchant_khmer_full_fields",
			"00020101021230350009khqr@devb01061234560208Dev Bank52045999530384054031005802KH5910John Smith6010PHNOM PENH62670106#123450211855122334550311Coffee Shop0709Cashier_10810Buy coffee64280002km0108ចន ស្មីន0206ភ្នំពញ993400131726822962612011317268230826126304A560",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "khqr@devb",
				MerchantID:              "123456",
				AcquiringBank:           "Dev Bank",
				MerchantType:            Merchant,
				TransactionCurrency:     "840",
				MerchantName:            "John Smith",
				TransactionAmount:       "100",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "PHNOM PENH",
				BillNumber:              "#12345",
				MobileNumber:            "85512233455",
				StoreLabel:              "Coffee Shop",
				TerminalLabel:           "Cashier_1",
				Purpose:                 "Buy coffee",
				AltLanguagePreference:   "km",
				AltMerchantName:         "ចន ស្មីន",
				AltMerchantCity:         "ភ្នំពញ",
				CreationTimestamp:       "1726822962612",
				ExpirationTimestamp:     "1726823082612",
				CRC:                     "A560",
			},
		},

		// --- Lenient CRC ---
		{
			"lenient_crc",
			"00020101021229190015john_smith@devb52045999530311654065000.05802KH5910jonh smith6010Phnom Penh62360109#INV-20030313Coffee Klaing0702#29917001316130279727576304FFFF",
			DecodedData{
				PayloadFormatIndicator:  "01",
				PointOfInitiationMethod: "12",
				BakongAccountID:         "john_smith@devb",
				MerchantType:            Individual,
				TransactionCurrency:     "116",
				MerchantName:            "jonh smith",
				TransactionAmount:       "5000.0",
				MerchantCategoryCode:    "5999",
				CountryCode:             "KH",
				MerchantCity:            "Phnom Penh",
				BillNumber:              "#INV-2003",
				StoreLabel:              "Coffee Klaing",
				TerminalLabel:           "#2",
				CreationTimestamp:       "1613027972757",
				CRC:                     "FFFF",
			},
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			t.Parallel()
			got, err := Decode(tt.qr)
			if err != nil {
				t.Fatalf("Decode() error = %v", err)
			}
			if *got != tt.want {
				t.Errorf("Decode() mismatch\ngot:  %+v\nwant: %+v", *got, tt.want)
			}
		})
	}
}

func TestDecodeInvalid(t *testing.T) {
	t.Parallel()

	tests := []struct {
		name string
		qr   string
	}{
		{"too_short", "EAB3"},
		{"truncated", "00020101021230190015"},
		{"malformed_tlv", "10263041234"},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			t.Parallel()
			_, err := Decode(tt.qr)
			if !errors.Is(err, ErrInvalidQR) {
				t.Errorf("Decode(%q) error = %v, want ErrInvalidQR", tt.qr, err)
			}
		})
	}
}
